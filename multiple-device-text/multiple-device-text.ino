//multiple device simulation from single device
#include <WiFi.h>
#include <PubSubClient.h>
#include <SPI.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128 
#define SCREEN_HEIGHT 32

#define OLED_RESET     -1 
#define SCREEN_ADDRESS 0x3C 
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);


// =========================
// Device Structure
// =========================
struct Device {
  String deviceId;
  float startLat, startLng;
  float endLat, endLng;
  float currentLat, currentLng;
  float stepLat, stepLng;
  int stepCount;
};

// =========================
// Two Devices
// =========================
Device devices[2] = {
  {
    "44e05f90-425a-43b5-b6f5-6225edf1b08b",  // Device 1 ID
    28.234662, 83.983002,  // Start
    28.233878, 83.990316,  // End
    28.234662, 83.983002,  // Current
    (28.233878 - 28.234662) / 20.0,          // stepLat
    (83.990316 - 83.983002) / 20.0,          // stepLng
    0
  },
  {
    "ea40c561-8fe4-4fad-863f-f34bf1504dc8",  // Device 2 ID
    28.232227, 83.990704,  // Start
    28.230046, 83.991208,  // End
    28.232227, 83.990704,  // Current
    (28.230046 - 28.232227) / 20.0,          // stepLat (end - start!)
    (83.991208 - 83.990704) / 20.0,          // stepLng
    0
  }
};

// =========================
// WiFi & MQTT Config
// =========================
const char* ssid = ".........._2.4";
const char* password = "135B@Santa$$246";
const char *mqtt_broker = "broker.emqx.io";
const char *topic = "esp32/loc";
const char *mqtt_username = "emqx";
const char *mqtt_password = "public";
const int mqtt_port = 1883;



// =========================
// Logo
// =========================
static const uint8_t image_data_Saraarray[1024] = {
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xf3, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xf3, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xe7, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xef, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xcd, 0x8f, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xff, 
    0xff, 0xff, 0xcd, 0xff, 0xff, 0xf1, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xfc, 0xff, 0xf8, 0xff, 0xff, 
    0xff, 0xff, 0x8c, 0x1f, 0xff, 0xf1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xf8, 0xff, 0xff, 
    0xff, 0xff, 0xce, 0x71, 0xff, 0xf1, 0xe7, 0xcc, 0xc7, 0xfc, 0xe1, 0xfc, 0x8f, 0x18, 0x9e, 0x3f, 
    0xff, 0xff, 0xcf, 0xfc, 0xff, 0xf1, 0xe3, 0x40, 0x45, 0xf8, 0xc8, 0xfc, 0x0e, 0x48, 0x0c, 0x9f, 
    0xff, 0xff, 0xef, 0xff, 0x7f, 0xf1, 0xe3, 0x44, 0x63, 0xf8, 0x8c, 0xfc, 0x44, 0x48, 0xcc, 0xcf, 
    0xff, 0xff, 0xff, 0xff, 0x3f, 0xf1, 0xf0, 0xc4, 0x63, 0xf8, 0x8c, 0xfc, 0xc4, 0x08, 0xc8, 0x0f, 
    0xff, 0xff, 0xff, 0xf8, 0x9f, 0xf1, 0xf0, 0xc4, 0x61, 0xf8, 0x8c, 0xfc, 0xc4, 0x78, 0xc8, 0xff, 
    0xff, 0xff, 0xff, 0xf8, 0x6f, 0xf1, 0xf9, 0xc4, 0x61, 0xc8, 0x8c, 0xfc, 0xc4, 0x68, 0xcc, 0xef, 
    0xff, 0xff, 0xff, 0xff, 0xe7, 0xf1, 0xf9, 0xc4, 0x58, 0x88, 0xc9, 0xfc, 0xc6, 0x68, 0xcc, 0x7f, 
    0xff, 0xff, 0xff, 0xff, 0xef, 0xf8, 0x39, 0xce, 0xfd, 0xfd, 0xf7, 0xfd, 0xcf, 0xfd, 0xdf, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xef, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xf8, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

WiFiClient espClient;
PubSubClient client(espClient);

unsigned long lastPublish = 0;
const unsigned long publishInterval = 3000; // 3 seconds

// =========================
// Fake GPS Path
// =========================
float startLat = 28.234662, startLng = 83.983002;
float endLat   = 28.233878, endLng   = 83.990316;

float currentLat = startLat;
float currentLng = startLng;
float stepLat = (endLat - startLat) / 20.0;   // 20 steps
float stepLng = (endLng - startLng) / 20.0;   // 20 steps

int stepCount = 0;

void showText(const String &text, int x=0, int y=0);

// =========================
// Setup
// =========================
void setup() {
  Serial.begin(115200);
  Serial.println("Initializing...");
  
  if(!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
        Serial.println(F("SSD1306 allocation failed"));
        for(;;); // Don't proceed, loop forever
        display.display();
        delay(2000); // Pause for 2 seconds
  }

  display.clearDisplay();
  display.drawBitmap(0,0, image_data_Saraarray,128,32,1);
  display.display();
  delay(2000);

  display.clearDisplay();
  showText("Initializing.....!");


  connectToWifi();
  connectToMQTT();

  WiFi.setAutoReconnect(true);
  WiFi.persistent(true);
}

void publishDevice(Device &dev) {
  // Move along path
  dev.currentLat += dev.stepLat;
  dev.currentLng += dev.stepLng;
  dev.stepCount++;

  if (dev.stepCount > 20) {
    dev.currentLat = dev.startLat;
    dev.currentLng = dev.startLng;
    dev.stepCount = 0;
  }

  float altitude = 850.0 + random(-10, 10);
  float speed = 30.0 + random(-5, 5);
  unsigned long timestamp = millis();

  // JSON payload
  String payload = "{";
  payload += "\"latitude\":" + String(dev.currentLat, 6) + ",";
  payload += "\"longitude\":" + String(dev.currentLng, 6) + ",";
  payload += "\"altitude\":" + String(altitude, 2) + ",";
  payload += "\"speed\":" + String(speed, 2) + ",";
  payload += "\"timestamp\":" + String(timestamp) + ",";
  payload += "\"deviceId\":\"" + dev.deviceId + "\"";
  payload += "}";

  if (client.connected()) {
    if (client.publish(topic, payload.c_str())) {
      Serial.println("Published: " + payload);
    } else {
      Serial.println("Publish failed!");
    }
  }
}

// =========================
// Main Loop
// =========================
void loop() {
if (millis() - lastPublish >= publishInterval) {
    for (int i = 0; i < 2; i++) {
      showText("device"+i,0,0);
      publishDevice(devices[i]);
    }
    lastPublish = millis();
  }

  if (!client.connected()) {
    attemptMQTTReconnect();
  }
  client.loop();

  if (!client.connected()) {
    attemptMQTTReconnect();
  }
  client.loop();
}

// =========================
// WiFi Functions
// =========================
void connectToWifi() {
  Serial.print("Connecting to WiFi: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  showText("Connecting to wifi!",0,6);
  int retries = 0;
  while (WiFi.status() != WL_CONNECTED && retries < 20) {
    delay(500);
    Serial.print(".");
    retries++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi connected. IP: " + WiFi.localIP().toString());
    showText("Connected to wifi.",0, 12);
  } else {
    Serial.println("\nFailed to connect to WiFi");
    showText("Connection Failed",0, 12);
  }
}

// =========================
// MQTT Functions
// =========================
void connectToMQTT() {
  client.setServer(mqtt_broker, mqtt_port);
  client.setCallback(callback);

  while (!client.connected()) {
    String client_id = "esp32-client-" + String(WiFi.macAddress());
    Serial.println("Connecting to MQTT...");
    showText("Connecting to MQTT...",0,17);

    if (client.connect(client_id.c_str(), mqtt_username, mqtt_password)) {
      Serial.println("MQTT connected!");
      showText("MQTT connected!",0,22);
      // client.publish(topic, "ESP32 Fake GPS connected");
    } else {
      Serial.printf("Failed, state: %d\n", client.state());
      showText("MQTT failed!",0,22);
      delay(2000);
    }
  }
}

bool attemptMQTTReconnect() {
  String client_id = "esp32-client-" + String(WiFi.macAddress());
  if (client.connect(client_id.c_str(), mqtt_username, mqtt_password)) {
    Serial.println("MQTT reconnected!");
    return true;
  }
  return false;
}

void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print("Message arrived on topic: ");
  Serial.println(topic);
}

void showText(const String &text, int x, int y) {
  display.clearDisplay();
  display.setTextSize(1);                
  display.setTextColor(SSD1306_WHITE);   
  display.setCursor(x, y);                
  display.println(text);              
  display.display();                     
}
